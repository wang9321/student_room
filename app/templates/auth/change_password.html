{% extends "common/base.html" %}

{% block title %}修改密码 - 电子科技大学成都学院自习室预约系统{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-shield-lock"></i> 修改密码
                    </h4>
                </div>
                <div class="card-body p-4">
                    <form method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- 当前密码 -->
                        <div class="mb-3">
                            <label for="old_password" class="form-label">当前密码</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-lock"></i>
                                </span>
                                <input type="password" class="form-control" id="old_password" name="old_password"
                                       placeholder="请输入当前密码" required>
                            </div>
                        </div>

                        <!-- 新密码 -->
                        <div class="mb-3">
                            <label for="new_password" class="form-label">新密码</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-key"></i>
                                </span>
                                <input type="password" class="form-control" id="new_password" name="new_password"
                                       placeholder="请输入新密码（至少6位）" required minlength="6">
                            </div>
                            <div class="form-text">密码长度至少6位</div>
                        </div>

                        <!-- 确认新密码 -->
                        <div class="mb-4">
                            <label for="confirm_password" class="form-label">确认新密码</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-key-fill"></i>
                                </span>
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password"
                                       placeholder="请再次输入新密码" required minlength="6">
                            </div>
                            <div class="form-text text-danger" id="password-match-error" style="display: none;">
                                新密码和确认密码不匹配
                            </div>
                        </div>

                        <!-- 按钮组 -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> 修改密码
                            </button>
                            <a href="{{ url_for('student.dashboard') if current_user.__class__.__name__ == 'Student' else url_for('admin.dashboard') }}"
                               class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> 返回
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 安全提示 -->
            <div class="alert alert-info mt-4">
                <h6 class="alert-heading">
                    <i class="bi bi-info-circle"></i> 安全提示
                </h6>
                <ul class="mb-0 small">
                    <li>建议使用包含字母、数字和特殊字符的强密码</li>
                    <li>不要使用过于简单的密码如"123456"或生日等</li>
                    <li>定期更换密码以保护账户安全</li>
                    <li>不要在公共场所或不信任的设备上保存密码</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 密码匹配验证
document.getElementById('confirm_password').addEventListener('input', function() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = this.value;
    const errorDiv = document.getElementById('password-match-error');

    if (confirmPassword && newPassword !== confirmPassword) {
        errorDiv.style.display = 'block';
        this.classList.add('is-invalid');
    } else {
        errorDiv.style.display = 'none';
        this.classList.remove('is-invalid');
        if (confirmPassword) {
            this.classList.add('is-valid');
        }
    }
});

// 新密码改变时清除确认密码的验证状态
document.getElementById('new_password').addEventListener('input', function() {
    const confirmPasswordField = document.getElementById('confirm_password');
    const errorDiv = document.getElementById('password-match-error');

    confirmPasswordField.classList.remove('is-valid', 'is-invalid');
    errorDiv.style.display = 'none';
});

// 表单提交前的最终验证
document.querySelector('form').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;

    if (newPassword !== confirmPassword) {
        e.preventDefault();
        document.getElementById('password-match-error').style.display = 'block';
        document.getElementById('confirm_password').classList.add('is-invalid');

        // 显示错误提示
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            新密码和确认密码不匹配，请重新输入。
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        const container = document.querySelector('.container');
        container.insertBefore(alert, container.firstChild);

        // 滚动到错误提示
        alert.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // 3秒后自动消失
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 3000);
    }
});
</script>
{% endblock %}