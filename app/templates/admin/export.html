{% extends "common/base.html" %}

{% block title %}数据导出 - 管理员后台{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="bi bi-download"></i> 数据导出</h4>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">管理后台</a></li>
                <li class="breadcrumb-item active">数据导出</li>
            </ol>
        </nav>
    </div>

    <!-- 导出说明 -->
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle"></i>
        <strong>导出说明：</strong>
        点击下方按钮可导出系统数据为CSV格式文件，便于数据备份和离线分析。
    </div>

    <!-- 数据导出选项 -->
    <div class="row">
        <!-- 用户数据 -->
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="bi bi-people"></i> 用户数据</h6>
                </div>
                <div class="card-body">
                    <p class="card-text">导出所有学生用户的基本信息、专业、年级、账户状态等数据。</p>
                    <ul class="list-unstyled small text-muted mb-3">
                        <li><i class="bi bi-check-circle"></i> 包含字段：学号、姓名、邮箱、专业、年级、班级等</li>
                        <li><i class="bi bi-check-circle"></i> 包含统计信息：信用积分、预约次数、违规记录</li>
                        <li><i class="bi bi-check-circle"></i> 包含状态信息：账户状态、创建时间</li>
                    </ul>
                    <button class="btn btn-primary w-100 export-btn" data-type="users">
                        <i class="bi bi-download"></i> 导出用户数据
                    </button>
                </div>
            </div>
        </div>

        <!-- 自习室数据 -->
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="bi bi-building"></i> 自习室数据</h6>
                </div>
                <div class="card-body">
                    <p class="card-text">导出所有自习室的详细信息、位置、容量和开放时间等数据。</p>
                    <ul class="list-unstyled small text-muted mb-3">
                        <li><i class="bi bi-check-circle"></i> 包含字段：教室编号、名称、楼栋、楼层</li>
                        <li><i class="bi bi-check-circle"></i> 包含位置信息：位置描述、容量、状态</li>
                        <li><i class="bi bi-check-circle"></i> 包含时间信息：开放时间、关闭时间</li>
                    </ul>
                    <button class="btn btn-success w-100 export-btn" data-type="rooms">
                        <i class="bi bi-download"></i> 导出自习室数据
                    </button>
                </div>
            </div>
        </div>

        <!-- 预约数据 -->
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-calendar-check"></i> 预约数据</h6>
                </div>
                <div class="card-body">
                    <p class="card-text">导出所有预约记录，包括学生信息、自习室、时间和状态等。</p>
                    <ul class="list-unstyled small text-muted mb-3">
                        <li><i class="bi bi-check-circle"></i> 包含字段：学生姓名、学号、自习室名称、座位号</li>
                        <li><i class="bi bi-check-circle"></i> 包含时间信息：预约日期、开始时间、结束时间</li>
                        <li><i class="bi bi-check-circle"></i> 包含状态信息：预约状态、签到时间、签退时间</li>
                    </ul>
                    <button class="btn btn-info w-100 export-btn" data-type="bookings">
                        <i class="bi bi-download"></i> 导出预约数据
                    </button>
                </div>
            </div>
        </div>

        <!-- 公告数据 -->
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="bi bi-megaphone"></i> 公告数据</h6>
                </div>
                <div class="card-body">
                    <p class="card-text">导出所有系统公告，包括标题、内容、发布时间和状态等。</p>
                    <ul class="list-unstyled small text-muted mb-3">
                        <li><i class="bi bi-check-circle"></i> 包含字段：公告标题、公告内容</li>
                        <li><i class="bi bi-check-circle"></i> 包含状态信息：发布状态、发布时间</li>
                        <li><i class="bi bi-check-circle"></i> 包含时间信息：创建时间</li>
                    </ul>
                    <button class="btn btn-warning w-100 export-btn" data-type="announcements">
                        <i class="bi bi-download"></i> 导出公告数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量导出 -->
    <div class="card mt-4">
        <div class="card-header bg-secondary text-white">
            <h6 class="mb-0"><i class="bi bi-file-earmark-zip"></i> 批量导出</h6>
        </div>
        <div class="card-body">
            <p class="card-text">一次性导出所有类型的数据为压缩包文件。</p>
            <button class="btn btn-secondary" id="exportAllBtn">
                <i class="bi bi-download"></i> 导出全部数据
            </button>
        </div>
    </div>
</div>

<!-- 导出进度模态框 -->
<div class="modal fade" id="exportProgressModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">正在导出</h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 mb-0" id="exportStatus">正在准备数据...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 单个数据导出
    $('.export-btn').on('click', function() {
        const dataType = $(this).data('type');
        const dataTypeNames = {
            'users': '用户数据',
            'rooms': '自习室数据',
            'bookings': '预约数据',
            'announcements': '公告数据'
        };

        // 显示进度模态框
        $('#exportStatus').text('正在导出' + dataTypeNames[dataType] + '...');
        $('#exportProgressModal').modal('show');

        // 导出数据
        $.ajax({
            url: '/admin/api/export_data?type=' + dataType,
            type: 'GET',
            success: function(response) {
                $('#exportProgressModal').modal('hide');
                if (response.success) {
                    exportToCsv(response.data, dataTypeNames[dataType] + '.csv');
                    showAlert(dataTypeNames[dataType] + '导出成功！', 'success');
                } else {
                    showAlert('导出失败：' + response.message, 'danger');
                }
            },
            error: function() {
                $('#exportProgressModal').modal('hide');
                showAlert('导出失败，请重试', 'danger');
            }
        });
    });

    // 批量导出功能（预留）
    $('#exportAllBtn').on('click', function() {
        showAlert('批量导出功能开发中，请稍后再试', 'warning');
    });

    // 导出为CSV文件
    function exportToCsv(data, filename) {
        const headers = Object.keys(data[0]);
        let csvContent = headers.join(',') + '\n';

        data.forEach(function(row) {
            const values = headers.map(header => {
                const value = row[header];
                // 处理可能包含逗号的字段
                if (typeof value === 'string' && (value.includes(',') || value.includes('\n'))) {
                    return '"' + value.replace(/"/g, '""') + '"';
                }
                return value;
            });
            csvContent += values.join(',') + '\n';
        });

        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 显示提示信息
    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        $('.container-fluid').prepend(alertHtml);

        // 3秒后自动消失
        setTimeout(() => {
            $('.alert').alert('close');
        }, 3000);
    }
});
</script>
{% endblock %}