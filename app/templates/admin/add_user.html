{% extends "common/base.html" %}

{% block title %}添加学生 - 管理员后台{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="bi bi-person-plus"></i> 添加学生</h4>
        <a href="{{ url_for('admin.users') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 返回用户管理
        </a>
    </div>

    <!-- 添加学生表单 -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">学生信息</h5>
                </div>
                <form method="POST" id="addUserForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">学号 *</label>
                                <input type="text" class="form-control" name="student_id" required
                                       placeholder="如：20240001" pattern="[0-9]{8}" title="请输入8位数字学号">
                                <div class="form-text">请输入8位数字学号</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">姓名 *</label>
                                <input type="text" class="form-control" name="name" required
                                       placeholder="请输入学生姓名">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">邮箱 *</label>
                                <input type="email" class="form-control" name="email" required
                                       placeholder="student@example.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">手机号</label>
                                <input type="tel" class="form-control" name="phone"
                                       placeholder="请输入手机号" pattern="[0-9]{11}" title="请输入11位手机号">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">专业 *</label>
                                <select class="form-select" name="major" required>
                                    <option value="">选择专业</option>
                                    <option value="计算机科学与技术">计算机科学与技术</option>
                                    <option value="软件工程">软件工程</option>
                                    <option value="电子信息工程">电子信息工程</option>
                                    <option value="通信工程">通信工程</option>
                                    <option value="自动化">自动化</option>
                                    <option value="机械工程">机械工程</option>
                                    <option value="土木工程">土木工程</option>
                                    <option value="工商管理">工商管理</option>
                                    <option value="会计学">会计学</option>
                                    <option value="英语">英语</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">年级 *</label>
                                <select class="form-select" name="grade" required>
                                    <option value="">选择年级</option>
                                    <option value="2024级">2024级</option>
                                    <option value="2023级">2023级</option>
                                    <option value="2022级">2022级</option>
                                    <option value="2021级">2021级</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">班级</label>
                                <input type="text" class="form-control" name="class_name"
                                       placeholder="如：1班">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">密码</label>
                                <input type="password" class="form-control" name="password"
                                       placeholder="留空则使用默认密码 123456">
                                <div class="form-text">留空将使用默认密码 123456</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">确认密码</label>
                                <input type="password" class="form-control" name="confirm_password"
                                       placeholder="请再次输入密码">
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>提示：</strong>
                            <ul class="mb-0 mt-2">
                                <li>带 * 的字段为必填项</li>
                                <li>初始信用分数为100分</li>
                                <li>新账户默认状态为激活</li>
                                <li>学号必须唯一，不能重复</li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('admin.users') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x"></i> 取消
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check"></i> 添加学生
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#addUserForm').on('submit', function(e) {
        e.preventDefault();

        // 表单验证
        const studentId = $('input[name="student_id"]').val().trim();
        const name = $('input[name="name"]').val().trim();
        const email = $('input[name="email"]').val().trim();
        const major = $('select[name="major"]').val();
        const grade = $('select[name="grade"]').val();
        const password = $('input[name="password"]').val();
        const confirmPassword = $('input[name="confirm_password"]').val();

        // 必填字段验证
        if (!studentId) {
            alert('请输入学号');
            return;
        }
        if (!name) {
            alert('请输入姓名');
            return;
        }
        if (!email) {
            alert('请输入邮箱');
            return;
        }
        if (!major) {
            alert('请选择专业');
            return;
        }
        if (!grade) {
            alert('请选择年级');
            return;
        }

        // 学号格式验证
        if (!/^[0-9]{8}$/.test(studentId)) {
            alert('学号必须为8位数字');
            return;
        }

        // 邮箱格式验证
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            alert('请输入有效的邮箱地址');
            return;
        }

        // 手机号格式验证（如果填写了）
        const phone = $('input[name="phone"]').val().trim();
        if (phone && !/^[0-9]{11}$/.test(phone)) {
            alert('手机号必须为11位数字');
            return;
        }

        // 密码确认验证
        if (password && password !== confirmPassword) {
            alert('两次输入的密码不一致');
            return;
        }

        // 提交表单
        const formData = new FormData(this);

        // 调试：打印FormData内容
        console.log('Form data before submission:');
        for (let [key, value] of formData.entries()) {
            console.log(key + ':', value);
        }

        $.ajax({
            url: '/admin/users/add',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    // 显示成功消息后跳转
                    alert('学生添加成功！');
                    window.location.href = '/admin/users';
                } else {
                    alert('添加失败：' + response.message);
                }
            },
            error: function(xhr) {
                if (xhr.status === 400) {
                    const response = xhr.responseJSON;
                    alert('添加失败：' + (response ? response.message : '请求参数错误'));
                } else {
                    alert('添加失败，请重试');
                }
            }
        });
    });
});
</script>
{% endblock %}